// Multiplayer WebSocket server
const WebSocket = require("ws");

const wss = new WebSocket.Server({ port: 8080 });
let players = {};

wss.on("connection", ws => {
    const id = Date.now().toString();
    players[id] = { x: 0, y: 1, z: 0 };

    ws.send(JSON.stringify({ type: "init", id, players }));

    ws.on("message", msg => {
        const data = JSON.parse(msg);

        if (data.type === "move") {
            players[id] = data.position;

            // broadcast movement to all players
            broadcast(JSON.stringify({
                type: "playerMove",
                id,
                position: data.position
            }));
        }
    });

    ws.on("close", () => {
        delete players[id];
        broadcast(JSON.stringify({ type: "playerLeft", id }));
    });
});

function broadcast(msg) {
    wss.clients.forEach(client => client.send(msg));
}

console.log("Multiplayer server running on ws://localhost:8080");
let socket;
let playerId = null;
let otherPlayers = {};
function connectMultiplayer() {
    socket = new WebSocket("ws://localhost:8080");

    socket.onmessage = e => {
        const data = JSON.parse(e.data);

        if (data.type === "init") {
            playerId = data.id;

            Object.keys(data.players).forEach(id => {
                if (id !== playerId) spawnOtherPlayer(id, data.players[id]);
            });
        }

        if (data.type === "playerMove") {
            moveOtherPlayer(data.id, data.position);
        }

        if (data.type === "playerLeft") {
            removeOtherPlayer(data.id);
        }
    };
}
function updatePlayerPosition() {
    const p = player.position;

    socket.send(JSON.stringify({
        type: "move",
        position: { x: p.x, y: p.y, z: p.z }
    }));
}
function spawnOtherPlayer(id, pos) {
    const geo = new THREE.BoxGeometry(1, 1.8, 1);
    const mat = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
    const mesh = new THREE.Mesh(geo, mat);

    mesh.position.set(pos.x, pos.y, pos.z);
    scene.add(mesh);

    otherPlayers[id] = mesh;
}
function moveOtherPlayer(id, pos) {
    if (!otherPlayers[id]) return;
    otherPlayers[id].position.set(pos.x, pos.y, pos.z);
}
function removeOtherPlayer(id) {
    if (otherPlayers[id]) {
        scene.remove(otherPlayers[id]);
        delete otherPlayers[id];
    }
}
